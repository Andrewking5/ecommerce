// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  // Shadow database is optional - only needed for prisma migrate dev
  // If not set, Prisma will try to use the same database (may require additional permissions)
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// 用戶模型
model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String? // 社交登录用户可能没有密码
  firstName String
  lastName  String
  phone     String?
  avatar    String? // 头像 URL
  role      Role    @default(USER)
  isActive  Boolean @default(true)

  // 社交登录相关
  provider     AuthProvider? @default(EMAIL) // 登录方式
  providerId   String? // 第三方平台的用户 ID
  providerData Json? // 存储第三方平台的额外信息

  // 国际化相关
  preferredLanguage String? @default("en") // 用户语言偏好: en, zh-TW, zh-CN, ja

  // AI推荐相关
  viewedProducts Json? // 浏览历史
  preferences    Json? // 用户偏好

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 關聯
  orders        Order[]
  reviews       Review[]
  cartItems     CartItem[]
  userBehaviors UserBehavior[]
  chatMessages  ChatMessage[]
  subscriptions Subscription[]
  addresses     UserAddress[]

  @@index([provider, providerId]) // 为社交登录查询优化
  @@map("users")
}

// 商品分類模型
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  image       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 關聯
  products           Product[]
  productAttributes  ProductAttribute[]
  attributeTemplates ProductAttributeTemplate[]

  @@index([isActive])
  @@index([slug])
  @@map("categories")
}

// 商品模型
model Product {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String
  price          Decimal  @db.Decimal(10, 2) // 保留用于向后兼容，如果 hasVariants=true 则作为 basePrice
  categoryId     String
  images         String[]
  stock          Int      @default(0) // 保留用于向后兼容，如果 hasVariants=true 则忽略
  specifications Json?
  model3dUrl     String? // 3D模型URL
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 变体相关字段
  hasVariants Boolean  @default(false) // 是否启用变体
  basePrice   Decimal? @db.Decimal(10, 2) // 基础价格（用于变体价格计算）
  minPrice    Decimal? @db.Decimal(10, 2) // 最低价格（自动计算）
  maxPrice    Decimal? @db.Decimal(10, 2) // 最高价格（自动计算）

  // 關聯
  category      Category         @relation(fields: [categoryId], references: [id])
  orderItems    OrderItem[]
  reviews       Review[]
  cartItems     CartItem[]
  userBehaviors UserBehavior[]
  subscriptions Subscription[]
  variants      ProductVariant[] // 商品变体

  @@index([categoryId])
  @@index([isActive])
  @@index([price])
  @@index([stock])
  @@index([createdAt])
  @@index([categoryId, isActive]) // 复合索引：按分类和状态查询
  @@index([hasVariants])
  @@map("products")
}

// 訂單模型
model Order {
  id              String      @id @default(cuid())
  userId          String
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  shippingCost    Decimal?    @db.Decimal(10, 2)
  taxAmount       Decimal?    @db.Decimal(10, 2)
  discountAmount  Decimal?    @db.Decimal(10, 2)
  couponCode      String?
  shippingAddress Json
  billingAddress  Json?
  paymentMethod   String
  paymentIntentId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // 關聯
  user       User        @relation(fields: [userId], references: [id])
  orderItems OrderItem[]
  payments   Payment[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// 訂單項目模型
model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  variantId String? // 变体ID（可选，用于支持变体订单）
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  // 關聯
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

// 商品評論模型
model Review {
  id           String   @id @default(cuid())
  productId    String
  userId       String
  rating       Int      @db.SmallInt
  comment      String?
  images       String[] // 评论图片
  isVerified   Boolean  @default(false) // 是否已验证购买
  helpfulCount Int      @default(0) // 有用数
  isApproved   Boolean  @default(false) // 管理员审核状态
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 關聯
  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([isApproved])
  @@index([rating])
  @@map("reviews")
}

// 購物車項目模型
model CartItem {
  id        String  @id @default(cuid())
  userId    String
  productId String
  variantId String? // 变体ID（可选，用于支持变体购物车）
  quantity  Int     @default(1)

  // 關聯
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId, variantId]) // 更新唯一约束以支持变体
  @@index([userId])
  @@index([productId])
  @@index([variantId])
  @@map("cart_items")
}

// 枚舉定義
enum Role {
  USER
  ADMIN
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
  FACEBOOK
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

// 优惠券模型
model Coupon {
  id          String     @id @default(cuid())
  code        String     @unique
  type        CouponType
  value       Decimal    @db.Decimal(10, 2)
  minPurchase Decimal?   @db.Decimal(10, 2)
  maxDiscount Decimal?   @db.Decimal(10, 2)
  usageLimit  Int? // 使用次数限制
  usedCount   Int        @default(0)
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

// 支付记录模型
model Payment {
  id                    String        @id @default(cuid())
  orderId               String
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("usd")
  status                PaymentStatus @default(PENDING)
  paymentMethod         String
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?
  refundAmount          Decimal?      @db.Decimal(10, 2)
  refundReason          String?
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // 關聯
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("payments")
}

// 用户行为模型
model UserBehavior {
  id        String         @id @default(cuid())
  userId    String
  productId String
  action    BehaviorAction
  metadata  Json?
  timestamp DateTime       @default(now())

  // 關聯
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([action])
  @@index([timestamp])
  @@map("user_behaviors")
}

// 聊天消息模型
model ChatMessage {
  id        String      @id @default(cuid())
  userId    String
  adminId   String?
  message   String
  type      MessageType @default(USER)
  isRead    Boolean     @default(false)
  metadata  Json?
  createdAt DateTime    @default(now())

  // 關聯
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([isRead])
  @@index([createdAt])
  @@map("chat_messages")
}

// 订阅模型
model Subscription {
  id               String                @id @default(cuid())
  userId           String
  productId        String
  frequency        SubscriptionFrequency
  nextDeliveryDate DateTime
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  // 關聯
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([isActive])
  @@index([nextDeliveryDate])
  @@map("subscriptions")
}

// 优惠券类型枚举
enum CouponType {
  PERCENTAGE
  FIXED
}

// 支付状态枚举
enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// 用户行为动作枚举
enum BehaviorAction {
  VIEW
  ADD_TO_CART
  PURCHASE
  REMOVE_FROM_CART
  SEARCH
}

// 消息类型枚举
enum MessageType {
  USER
  ADMIN
  SYSTEM
}

// 订阅频率枚举
enum SubscriptionFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
}

// 用户地址模型
model UserAddress {
  id            String   @id @default(cuid())
  userId        String
  recipientName String // 收件人姓名
  phone         String // 联系电话
  province      String // 省
  city          String // 市
  district      String // 区
  street        String // 详细地址
  zipCode       String? // 邮编
  label         String? // 标签：家/公司/学校/自定义
  isDefault     Boolean  @default(false) // 是否默认地址
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 關聯
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@map("user_addresses")
}

// 商品属性模型（定义属性类型：颜色、尺寸等）
model ProductAttribute {
  id           String        @id @default(cuid())
  name         String // 属性名称：颜色、尺寸、材质等
  displayName  String? // 显示名称：如"颜色"、"尺寸"
  type         AttributeType
  categoryId   String? // 可选：特定分类的属性
  values       Json // 预设值列表：["红色", "蓝色", "绿色"]
  isRequired   Boolean       @default(false)
  displayOrder Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // 關聯
  category Category?                 @relation(fields: [categoryId], references: [id])
  variants ProductVariantAttribute[]

  @@index([categoryId])
  @@index([name])
  @@map("product_attributes")
}

// 属性类型枚举
enum AttributeType {
  TEXT // 文本输入
  COLOR // 颜色选择器（显示色块）
  IMAGE // 图片选择
  SELECT // 下拉选择
  NUMBER // 数字输入（如：容量、重量）
}

// 商品变体模型（SKU）
model ProductVariant {
  id            String   @id @default(cuid())
  productId     String
  sku           String   @unique
  price         Decimal  @db.Decimal(10, 2)
  comparePrice  Decimal? @db.Decimal(10, 2) // 原价（用于显示折扣）
  costPrice     Decimal? @db.Decimal(10, 2) // 成本价
  stock         Int      @default(0)
  reservedStock Int      @default(0) // 预留库存
  weight        Decimal? @db.Decimal(10, 2)
  dimensions    Json? // {length, width, height}
  barcode       String?
  images        String[] // 变体专属图片
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  displayOrder  Int      @default(0) // 显示顺序
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 關聯
  product    Product                   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributes ProductVariantAttribute[]
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([productId])
  @@index([sku])
  @@index([isActive])
  @@index([productId, isActive])
  @@map("product_variants")
}

// 变体属性关联模型
model ProductVariantAttribute {
  id           String  @id @default(cuid())
  variantId    String
  attributeId  String
  value        String // 属性值
  displayValue String? // 显示值（如颜色代码）

  // 關聯
  variant   ProductVariant   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  attribute ProductAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeId])
  @@index([variantId])
  @@index([attributeId])
  @@map("product_variant_attributes")
}

// 属性模板模型（预设常用属性组合）
model ProductAttributeTemplate {
  id         String   @id @default(cuid())
  name       String // 模板名称：如"服装标准"、"电子产品"
  categoryId String?
  attributes Json // 预设的属性配置
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // 關聯
  category Category? @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isDefault])
  @@map("product_attribute_templates")
}
